<!-- 
@author: Maolin Tu
@blog: http://tumaolin.com
 -->
<!DOCTYPE html>
<html>
<head>
    <title>Stock</title>
    <!--importing highcharts-->
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <!--CSS file-->
    <link rel="stylesheet" type="text/css" href="style.css" />
    <!-- JS file -->
    <script src="myScript.js"></script>
    <script>
function submitSymbol(what){
    var symbol = what.symbol.value;
    if(symbol==""){
        alert("Please enter a symbol");
        return;
    }
    console.log(symbol);

    document.getElementById('symbol').value=symbol;
    var url = "https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=" +symbol+"&outputsize=full&apikey=FEY146OML7L2A34X";
    console.log(url);

    var xmlhttp;
    if(window.XMLHttpRequest) {
                    xmlhttp = new XMLHttpRequest();
                } else {
                    xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                }
      xmlhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        try{
                            jsonObj = JSON.parse(xmlhttp.responseText);
                             // alert(jsonObj);
                            generateTable(jsonObj);
                            console.log(jsonObj);
                        }catch(e){
                            alert("JSON File Syntax Error");
                            console.log(jsonObj);
                            console.log(e);
                            return null;
                        }
                    }
                };
      xmlhttp.open("GET", url, true);
      xmlhttp.send();
}

        var symbol ;
        var ReDate ;
        var open ;
        var close ;
        var pre_close ;
        var day_range ;
        var volume ;

        var data1 = [];
        var data2 = [];
        var date = [];
        var max = -1000000000;
        var min = 1000000000;
        var volume_max = -1000000000;     

/*
 *Generate Stock Information Table
 *@para jsonObj JSON Object 
 */ 
function generateTable(jsonObj){
    if(jsonObj.hasOwnProperty('Error Message')){
        var htmlText="";
        htmlText +="<div class='table_container' id='error_container'><table><tr>";
        htmlText +="<td class='left'>Error</td>";
        htmlText +="<td class='right'>Error: No record has been found, please enter a valid symbol</td>";
        htmlText +="</tr></table></div>";
        document.getElementById("whole_container").innerHTML=htmlText;
    }else{
        var meta = jsonObj['Meta Data'];
        var array_values = jsonObj['Time Series (Daily)'];
        symbol = meta['2. Symbol'];
        ReDate = meta['3. Last Refreshed'];
  
        var count =0;
        for(var key in array_values){
            if(count==0){
                open = array_values[key]['1. open'];
                close = array_values[key]['4. close'];
                day_range = array_values[key]['3. low']+"-"+array_values[key]['2. high'];
                volume = array_values[key]['5. volume'];
            }
            if(count == 1){
                pre_close = array_values[key]['4. close'];
            }
            var temp_date = key.substring(5).replace(/-/g, "\/");
            if(temp_date.length>=6) temp_date = temp_date.substr(0,5);
            date.push(temp_date);            
            data1.push(parseFloat(array_values[key]['4. close']));
            data2.push(parseFloat(array_values[key]['5. volume']));
            max = Math.max(parseFloat(array_values[key]['4. close']),max);
            min = Math.min(parseFloat(array_values[key]['4. close']),min);
            volume_max = Math.max(parseFloat(array_values[key]['5. volume']),max);
            if(count==126){
                break;
            }
            count++;
        }

        data1.reverse();
        data2.reverse();
        date.reverse();
        console.log(data1);
        
        var change = (close - pre_close).toFixed(2);
        var change_per = (change/pre_close*100).toFixed(2);

        var htmlText="";
        htmlText +="<div class='table_container' id='data_container'><table>";
        htmlText +="<tr><td class='left'>Stock Ticker Symbol</td>";
        htmlText +="<td class='right'>"+symbol+"</td></tr>";

        htmlText +="<tr><td class='left'>Close</td>";
        htmlText +="<td class='right'>"+close+"</td></tr>";

        htmlText +="<tr><td class='left'>Open</td>";
        htmlText +="<td class='right'>"+open+"</td></tr>";

        htmlText +="<tr><td class='left'>Previous Close</td>";
        htmlText +="<td class='right'>"+pre_close+"</td></tr>";
        htmlText +="<tr><td class='left'>Change</td>";
        htmlText +="<td class='right'>";
        if(change>=0){
            htmlText +=change;
            htmlText +="&nbsp<img src='http://cs-server.usc.edu:45678/hw/hw6/images/Green_Arrow_Up.png' alt='up' width='15' height='15'>";
        }else{
            htmlText +=change*-1;
            htmlText +="&nbsp<img src='http://cs-server.usc.edu:45678/hw/hw6/images/Red_Arrow_Down.png' alt='up' width='15' height='15'>";
        }
        htmlText +="</td></tr>";
        htmlText +="<tr><td class='left'>Change Percent</td>";
        htmlText +="<td class='right'>";
        if(change>=0){
            htmlText +=change_per;
            htmlText +="%&nbsp<img src='http://cs-server.usc.edu:45678/hw/hw6/images/Green_Arrow_Up.png' alt='up' width='15' height='15'>";
        }else{
            htmlText +=change_per*-1;
            htmlText +="%&nbsp<img src='http://cs-server.usc.edu:45678/hw/hw6/images/Red_Arrow_Down.png' alt='up' width='15' height='15'>";
        }
        htmlText +="</td></tr>";

        htmlText +="<tr><td class='left'>Day's Range</td>";
        htmlText +="<td class='right'>"+day_range+"</td></tr>";
        htmlText +="<tr><td class='left'>Volume</td>";
        htmlText +="<td class='right'>"+volume+"</td></tr>";
        htmlText +="<tr><td class='left'>Timestamp</td>";
        htmlText +="<td class='right'>"+ReDate+"</td></tr>";
        htmlText +="<tr><td class='left'>Indicators</td>";
        htmlText +="<td class='right'>";

        htmlText +="<a href='javascript:drawPrice()'>Price</a>&nbsp&nbsp";
        htmlText +="<a href=''>SMA</a>&nbsp&nbsp";
        htmlText +="<a href=''>EMA</a>&nbsp&nbsp";
        htmlText +="<a href=''>STOCH</a>&nbsp&nbsp";
        htmlText +="<a href=''>RSI</a>&nbsp&nbsp";
        htmlText +="<a href=''>ADX</a>&nbsp&nbsp";
        htmlText +="<a href=''>CCI</a>&nbsp&nbsp";
        htmlText +="<a href=''>BBANDS</a>&nbsp&nbsp";
        htmlText +="<a href=''>MACD</a>&nbsp&nbsp";
        htmlText +="</td></tr>";
        htmlText +="</table></div><br>";
        document.getElementById("whole_container").innerHTML=htmlText;

        drawAreaAndVolume();
    }
}

function drawPrice(){
    drawAreaAndVolume(ReDate, symbol, date,data1,data2,min,max,volume_max);
}

function drawAreaAndVolume(){
    document.getElementById('container').style.visibility='visible';
    console.log(date);
    console.log(data1);
    console.log(data2);
    var chartTitle = "Stock Price (" +ReDate+ ")";
    var myChart = Highcharts.chart('container', {
        chart: {
            zoomType: 'x'
        },
        
        title: {
            text: chartTitle
        },
        subtitle: {
        useHTML:true,
        text: "<a style=' text-decoration: none' target='_blank' href='https://www.alphavantage.co/' >Source: Alpha Vantage</a>" 
        },
        xAxis: {
            categories:date,
            tickInterval:5,
            tickPositioner: function() {
            let res = [];
            for(let i = 0; i < this.categories.length; i++) {
                if(i % 5 == 0) res.push(this.categories.length-i-1);
            }
            return res;
        }
        },
        yAxis: [{
            title: {
                text: 'Stock Price'
            },
            
         "min":min*0.5,
        },{
          "title": {
                "text": 'Volume'
            },
          
          "opposite": true,
          "max": volume_max*8
        }],
        
        series: [{
            name: symbol,
            type: 'area',
            threshold: null,
            lineWidth: 1,
            lineColor: 'red',
            data: data1,
            color: '#ff0000',
            fillOpacity: 0.5,
            "marker":{
            "enabled":false
            },
            tooltip: {
            valueDecimals: 2
        }

        }, {
            name: symbol+' Volume',
            type: 'column',
            color: '#ffffff',
            yAxis: 1,
            data: data2
        }],
        legend: {
            layout: 'vertical',
            verticalAlign: 'middle',
            align: 'right'
            
        },
    });
}

    </script>
</head>
<body>
    <div class="input_container" >
        <h1><i>Stock Search</i></h1>
        <div class="line"></div>
        <form id="form1" method="POST">
            Enter Stock Ticker Symbol:*<input id="symbol" type="text" name="symbol" value=""><br>
            <input id="sub" type="button" name="submit" onclick="submitSymbol(this.form)" value="Search">
            &nbsp&nbsp
            <input type = "button" onclick="formReset()" value="Clear"><br>
            * - <i>Mandatory fields.</i>
            <br><br><br>
        </form> 
    </div>
    <div id="whole_container">
        
    </div>
    <div id="container"></div>
    

</body>
</html>